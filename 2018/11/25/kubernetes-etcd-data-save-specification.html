<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kubernetesç»„ä»¶ETCDä¸­å­˜å‚¨çš„æ•°æ®ä¹‹æ¢ç©¶ - æ•¬ç»´</title>
    <meta name="author"  content="Jingç»´">
    <meta name="description" content="Kubernetesç»„ä»¶ETCDä¸­å­˜å‚¨çš„æ•°æ®ä¹‹æ¢ç©¶">
    <meta name="keywords"  content="DevOps, ç»éªŒ, k8s">
    <!-- Open Graph -->
    <meta property="og:title" content="Kubernetesç»„ä»¶ETCDä¸­å­˜å‚¨çš„æ•°æ®ä¹‹æ¢ç©¶ - æ•¬ç»´">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://jingwei.link/2018/11/25/kubernetes-etcd-data-save-specification.html">
    <meta property="og:description" content="ä¸€ä¸ªå–œæ¬¢æ¶‚æ¶‚ç”»ç”»çš„äººï¼Œæ›¾ç»çš„Rubistï¼Œä¸€ä¸ªCI/CDçš„è·µè¡Œè€…ï¼Œä¸€ä¸ªæ¢å¯»æœ€ä½³å®è·µçš„äººã€‚">
    <meta property="og:site_name" content="æ•¬ç»´">
    <link rel="stylesheet" href="//cdn.staticfile.org/normalize/6.0.0/normalize.min.css">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_roc50gemkxpw4s4i.css">
    <link rel="stylesheet" href="/assets/css/github-markdown.css">
    <link rel="stylesheet" href="/assets/css/prism.css">
    <link rel="stylesheet" href="/assets/css/share.min.css">
    <link rel="stylesheet" href="/assets/css/app.min.css">
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
	
	<!--
Author: Ray-Eldath
refer to:
 - http://docs.mathjax.org/en/latest/options/index.html
-->

	<script type="text/javascript" async src="https://cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script>
	
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
		jax: ["input/TeX", "output/HTML-CSS"],
		tex2jax: {
			inlineMath: [ ["$", "$"] ],
			displayMath: [ ["$$", "$$"] ],
			skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
		},
		"HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
      });
    </script>

	
    <!--
Author: Ray-Eldath
-->
<style>
    .markdown-body .anchor{
        float: left;
        margin-top: -8px;
        margin-left: -20px;
        padding-right: 4px;
        line-height: 1;
        opacity: 0;
    }
    
    .markdown-body .anchor .anchor-icon{
        font-size: 15px
    }
</style>
<script>
    $(document).ready(function() {
        let nodes = document.querySelector(".markdown-body").querySelectorAll("h1,h2,h3")
        for(let node of nodes) {
            var anchor = document.createElement("a")
            var anchorIcon = document.createElement("i")
            anchorIcon.setAttribute("class", "fa fa-anchor fa-lg anchor-icon")
            anchorIcon.setAttribute("aria-hidden", true)
            anchor.setAttribute("class", "anchor")
            anchor.setAttribute("href", "#" + node.getAttribute("id"))
            
            anchor.onmouseover = function() {
                this.style.opacity = "0.4"
            }
            
            anchor.onmouseout = function() {
                this.style.opacity = "0"
            }
            
            anchor.appendChild(anchorIcon)
            node.appendChild(anchor)
        }
    })
</script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-121993438-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-121993438-1');
    </script>
</head>


<body>
  <!--[if lt IE 10]>
<div class="alert-danger" role="alert">ä½ çš„æµè§ˆå™¨å®åœ¨å¤ªå¤ªå¤ªæ—§äº†ï¼Œæ”¾å­¦åˆ«èµ°ï¼Œå‡çº§å®Œæµè§ˆå™¨å†è¯´ï¼<a target="_blank" class="alert-link" href="http://browsehappy.com">ç«‹å³å‡çº§</a></div>
<![endif]-->
  <input id="nm-switch" type="hidden" value="true"> <header class="g-header">
    <div class="g-logo">
      <a href="/"></a>
    </div>
    <i id="menu-toggle" class="iconfont icon-menu"></i>
    <nav class="g-nav">
        <ul>
            
            <li><a href="/">home</a></li>
            
            <li><a href="/tags.html">tags</a></li>
            
        </ul>
    </nav>
</header>


  <header class="g-banner post-header post-pattern-circuitBoard bgcolor-default " data-theme="default">
    <div class="post-wrapper">
      <div class="post-tags">
        
          
            <a href="https://jingwei.link/tags#DevOps" class="post-tag">DevOps</a>
          
            <a href="https://jingwei.link/tags#%E7%BB%8F%E9%AA%8C" class="post-tag">ç»éªŒ</a>
          
            <a href="https://jingwei.link/tags#k8s" class="post-tag">k8s</a>
          
        
      </div>
      <h1>Kubernetesç»„ä»¶ETCDä¸­å­˜å‚¨çš„æ•°æ®ä¹‹æ¢ç©¶</h1>
      <div class="post-meta">
        <span class="post-meta-item"><i class="iconfont icon-author"></i><a href="https://jingwei.link" target="_blank" rel="author">Jingç»´</a></></span>
        <time class="post-meta-item" datetime="18-11-25"><i class="iconfont icon-date"></i>25 Nov 2018</time>
      </div>
    </div>
    
    <div class="filter"></div>
      <div class="post-cover" style="background: url('') center no-repeat; background-size: cover;"></div>
    
  </header>

  <div class="post-content visible">
    
    <h2 class="post-subtitle">æ¢ç´¢Kubernetesåœ¨ETCDä¸­ä¿å­˜æ•°æ®çš„è§„èŒƒ</h2>
    

    <article class="markdown-body">
      <ul id="markdown-toc">
  <li><a href="#å†™åœ¨å‰é¢" id="markdown-toc-å†™åœ¨å‰é¢">å†™åœ¨å‰é¢</a></li>
  <li><a href="#é€‚ç”¨äººç¾¤" id="markdown-toc-é€‚ç”¨äººç¾¤">é€‚ç”¨äººç¾¤</a></li>
  <li><a href="#æ¢ç©¶æ­£æ–‡" id="markdown-toc-æ¢ç©¶æ­£æ–‡">æ¢ç©¶æ­£æ–‡</a>    <ul>
      <li><a href="#ç›¸å…³ç¯å¢ƒ" id="markdown-toc-ç›¸å…³ç¯å¢ƒ">ç›¸å…³ç¯å¢ƒ</a></li>
      <li><a href="#k8sä¸­etcdæ•°æ®çš„å¢åˆ æ”¹æŸ¥" id="markdown-toc-k8sä¸­etcdæ•°æ®çš„å¢åˆ æ”¹æŸ¥">k8sä¸­ETCDæ•°æ®çš„å¢åˆ æ”¹æŸ¥</a></li>
      <li><a href="#åˆæ¢etcdä¸­çš„æ•°æ®" id="markdown-toc-åˆæ¢etcdä¸­çš„æ•°æ®">åˆæ¢ETCDä¸­çš„æ•°æ®</a>        <ul>
          <li><a href="#è·å–etcdä¸­çš„æ‰€æœ‰çš„keyå€¼" id="markdown-toc-è·å–etcdä¸­çš„æ‰€æœ‰çš„keyå€¼">è·å–ETCDä¸­çš„æ‰€æœ‰çš„keyå€¼</a></li>
          <li><a href="#etcdä¸­keyå€¼çš„è§„å¾‹" id="markdown-toc-etcdä¸­keyå€¼çš„è§„å¾‹">ETCDä¸­keyå€¼çš„è§„å¾‹</a></li>
          <li><a href="#etcdä¸­çš„valueå€¼" id="markdown-toc-etcdä¸­çš„valueå€¼">ETCDä¸­çš„valueå€¼</a></li>
        </ul>
      </li>
      <li><a href="#etcdä¸­å…¶ä»–çš„keyåŠå…¶value" id="markdown-toc-etcdä¸­å…¶ä»–çš„keyåŠå…¶value">ETCDä¸­å…¶ä»–çš„keyåŠå…¶value</a>        <ul>
          <li><a href="#æ®è¯´flanneléœ€è¦ä½¿ç”¨etcdä¿å­˜ç½‘ç»œå…ƒæ•°æ®" id="markdown-toc-æ®è¯´flanneléœ€è¦ä½¿ç”¨etcdä¿å­˜ç½‘ç»œå…ƒæ•°æ®">æ®è¯´flanneléœ€è¦ä½¿ç”¨ETCDä¿å­˜ç½‘ç»œå…ƒæ•°æ®</a></li>
          <li><a href="#defaultå‘½åç©ºé—´ä¸­endpointå®ä¾‹kubernetesçš„å€¼" id="markdown-toc-defaultå‘½åç©ºé—´ä¸­endpointå®ä¾‹kubernetesçš„å€¼">defaultå‘½åç©ºé—´ä¸­endpointå®ä¾‹kubernetesçš„å€¼</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#å°ç»“" id="markdown-toc-å°ç»“">å°ç»“</a></li>
  <li><a href="#å‚è€ƒ" id="markdown-toc-å‚è€ƒ">å‚è€ƒ</a></li>
</ul>

<h2 id="å†™åœ¨å‰é¢">å†™åœ¨å‰é¢</h2>
<p><a href="https://kubernetes.io/">Kubernetes</a>  ï¼ˆç®€ç§°k8sï¼‰æ˜¯å®¹å™¨é›†ç¾¤ç®¡ç†ç³»ç»Ÿï¼Œæ˜¯ä¸€ä¸ªå¼€æºçš„å¹³å°ï¼Œå¯ä»¥å®ç°å®¹å™¨é›†ç¾¤çš„è‡ªåŠ¨åŒ–éƒ¨ç½²ã€è‡ªåŠ¨æ‰©ç¼©å®¹ã€ç»´æŠ¤ç­‰åŠŸèƒ½ï¼Œå…·ä½“çš„å¤§å®¶å¯ä»¥å‚è€ƒ <a href="http://docs.kubernetes.org.cn/227.html">Kubernetesä¸­æ–‡æ–‡æ¡£</a> æˆ–è€…<a href="https://kubernetes.io/zh/docs/home/">Kuberneteså®˜ç½‘çš„æ–‡æ¡£</a>ã€‚</p>

<p>K8sçš„æ¶æ„å¤æ‚ï¼Œæ¶‰åŠåˆ°æ¦‚å¿µéå¸¸å¤šï¼Œå…¶åŸºç¡€ç»„ä»¶åŒ…å« ETCDã€kube-apiserverã€kube-controller-managerã€kube-schedulerã€kubeletã€kube-proxyç­‰ï¼Œå…¶è¿è¡Œæ—¶ç¯å¢ƒä¸ºdockeræˆ–Rktï¼Œå½“ç„¶è¿˜åŒ…å«å¾ˆå¤šæ’ä»¶ã€‚åœ¨æˆ‘çœ‹æ¥ï¼Œk8sæ˜¯DevOpsçš„æœªæ¥ï¼Œå› æ­¤ä¸ç¦æƒ³å†™ä¸€äº›å®ƒçš„æ•…äº‹ã€‚</p>

<p>ETCDåœ¨k8sæŠ€æœ¯æ ˆçš„åœ°ä½ï¼Œå°±ä»¿ä½›æ•°æ®åº“ï¼ˆMysqlã€Postgresqlæˆ–oracleç­‰ï¼‰åœ¨Webåº”ç”¨ä¸­çš„åœ°ä½ï¼Œå®ƒå­˜å‚¨äº†k8sé›†ç¾¤ä¸­æ‰€æœ‰çš„å…ƒæ•°æ®ï¼ˆä»¥key-valueçš„æ–¹å¼ï¼‰ã€‚é‚£ä¹ˆå¾ˆç°å®çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼šè¿™äº›å…ƒæ•°æ®æ˜¯å¦‚ä½•ç»„ç»‡å¹¶ä¿å­˜çš„å‘¢ï¼Ÿæœ¬æ–‡å°±å¯¹æ­¤é—®é¢˜æ¢ç©¶ä¸€ç•ªã€‚</p>

<h2 id="é€‚ç”¨äººç¾¤">é€‚ç”¨äººç¾¤</h2>
<p>å…¥é—¨â€”â€”åˆçº§â€”â€”<strong>ä¸­çº§âˆš</strong>â€”â€”é«˜çº§ï¼›æœ¬æ–‡é€‚åº”ä¸­çº§åŠä»¥ä¸Šã€‚</p>

<h2 id="æ¢ç©¶æ­£æ–‡">æ¢ç©¶æ­£æ–‡</h2>
<h3 id="ç›¸å…³ç¯å¢ƒ">ç›¸å…³ç¯å¢ƒ</h3>
<ul>
  <li>ä¸¤å°2ä¸ªæ ¸4Gå†…å­˜ï¼ˆ2C4Gï¼‰çš„è™šæ‹Ÿæœºï¼Œipåˆ†åˆ«ä¸º<code class="language-plaintext highlighter-rouge">192.168.205.137</code>å’Œ<code class="language-plaintext highlighter-rouge">192.168.205.139</code></li>
  <li>k8sç›¸å…³æ§ä»¶-1.8.6</li>
  <li>etcd-3.3.10</li>
  <li>docker-18.06.1-ce</li>
</ul>

<p>æˆ‘è¿™é‡Œé‡‡ç”¨äº†<a href="https://kubernetes.io/docs/setup/independent/high-availability/">kubeadm</a>çš„éƒ¨ç½²æ–¹æ³•ï¼Œæ¢ç´¢äº†é«˜å¯ç”¨ï¼ˆHAï¼‰éƒ¨ç½²æ–¹æ¡ˆï¼ˆæ¨èå‚è€ƒä¸€ä¸‹<a href="https://github.com/cookeem/kubeadm-ha/">è¿™é‡Œ</a> ï¼Œæœªæ¥ä¼šè€ƒè™‘å†™ä¸€ç¯‡å…³äºk8sé«˜å¯ç”¨åŸç†çš„åšæ–‡ï¼Œæ•¬è¯·æœŸå¾…ğŸ˜ï¼‰ã€‚</p>

<h3 id="k8sä¸­etcdæ•°æ®çš„å¢åˆ æ”¹æŸ¥">k8sä¸­ETCDæ•°æ®çš„å¢åˆ æ”¹æŸ¥</h3>
<p>é¦–å…ˆåº”è¯¥æ˜ç¡®ï¼Œ<strong>K8sä¸­æ‰€æœ‰å…ƒæ•°æ®çš„å¢åˆ æ”¹æŸ¥éƒ½æ˜¯ç”±kube-apiserveræ¥æ‰§è¡Œçš„</strong>ï¼Œé‚£ä¹ˆè¿™äº›æ•°æ®åœ¨ETCDä¸­å¿…ç„¶æœ‰ä¸€å¥—å­˜å‚¨è§„èŒƒï¼Œè¿™æ ·æ‰èƒ½ä¿è¯åœ¨é›†ç¾¤ä¸­éƒ¨ç½²æˆåƒä¸Šä¸‡çš„åº”ç”¨æ—¶ä¸ä¼šå‡ºå·®é”™ã€‚åœ¨æ­¤åŸºç¡€ä¸Šå¯ä»¥è®¤ä¸ºï¼Œåªè¦æŒæ¡äº†k8såœ¨ETCDä¸­å­˜å‚¨æ•°æ®çš„è§„èŒƒï¼Œä¾¿å¯ä»¥åƒk8sä¸€æ ·æ‰‹åŠ¨æ¥æ“ä½œETCDäº†ï¼ˆè™½ç„¶ä¸å»ºè®®è¿™ä¹ˆåšï¼‰ã€‚ä¸è¿‡æ›´å¤§çš„ä»·å€¼æ˜¯èƒ½å¯¹k8sçš„ç†è§£æ›´è¿›ä¸€æ­¥ï¼Œä¾¿äºä»¥ådebugæˆ–è€…äºŒæ¬¡å¼€å‘k8sçš„æŸäº›åŠŸèƒ½æ—¶æ›´æœ‰åº•æ°”ã€‚</p>

<h3 id="åˆæ¢etcdä¸­çš„æ•°æ®">åˆæ¢ETCDä¸­çš„æ•°æ®</h3>
<p>æœ¬æ–‡å¯¹ETCDçš„æ“ä½œä¸»è¦ä½¿ç”¨äº†å…¶å®˜æ–¹å®¢æˆ·ç«¯å·¥å…·<a href="https://github.com/etcd-io/etcd/tree/master/etcdctl">etcdctl</a>ï¼Œè¿™é‡Œä¸å¯¹etcdctlè¿›è¡Œè¯¦è§£äº†ï¼ˆéœ€è¦ç”¨ä¸€æ•´ç¯‡åšå®¢æ¥ä»‹ç»å®ƒæ‰è¡Œï¼‰ï¼Œåªå°±ç”¨åˆ°çš„ä¸€äº›å‘½ä»¤è¿›è¡Œé˜é‡Šã€‚</p>

<h4 id="è·å–etcdä¸­çš„æ‰€æœ‰çš„keyå€¼">è·å–ETCDä¸­çš„æ‰€æœ‰çš„keyå€¼</h4>
<p>ä¸‹é¢çš„å‘½ä»¤å¯ä»¥è·å–ETCDä¸­çš„æ‰€æœ‰çš„keyå€¼ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># è·å–ETCDä¸­çš„æ‰€æœ‰æ•°æ®</span>
<span class="c"># --prefix è¡¨ç¤ºè·å–æ‰€æœ‰keyå€¼å¤´ä¸ºæŸä¸ªå­—ç¬¦ä¸²çš„æ•°æ®ï¼Œ ç”±äºä¼ å…¥çš„æ˜¯""ï¼Œæ‰€ä»¥ä¼šåŒ¹é…æ‰€æœ‰çš„å€¼</span>
<span class="c"># --keys-only è¡¨ç¤ºåªè¿”å›keyè€Œä¸è¿”å›value</span>
<span class="c"># å¯¹è¾“å‡ºçš„ç»“æœä½¿ç”¨grepè¿‡æ»¤æ‰ç©ºè¡Œ</span>
/<span class="nv">$ ETCDCTL_API</span><span class="o">=</span>3 etcdctl get <span class="s2">""</span> <span class="nt">--prefix</span> <span class="nt">--keys-only</span> |grep <span class="nt">-Ev</span> <span class="s2">"^$"</span>

<span class="c"># è¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼Œå®é™…æ•°æ®ä¼šéå¸¸æ•´é½</span>
/registry/apiextensions.k8s.io/customresourcedefinitions/globalbgpconfigs.crd.projectcalico.org
/registry/apiextensions.k8s.io/customresourcedefinitions/globalfelixconfigs.crd.projectcalico.org
/registry/apiextensions.k8s.io/customresourcedefinitions/globalnetworkpolicies.crd.projectcalico.org
<span class="c"># ... ç•¥è¿‡å¾ˆå¤šæ¡ç›®</span>
/registry/namespaces/default
/registry/namespaces/kube-public
/registry/namespaces/kube-system
/registry/pods/kube-system/canal-mljsv
/registry/pods/kube-system/canal-qlvh6
<span class="c"># ... ç•¥è¿‡å¾ˆå¤šæ¡ç›®</span>
/registry/services/endpoints/kube-system/kube-scheduler
/registry/services/specs/default/kubernetes
/registry/services/specs/kube-system/kube-dns
compact_rev_key

<span class="c"># æ€»å…±æœ‰240æ¡è®°å½•</span>
/<span class="nv">$ </span>etcdctl get <span class="s2">""</span> <span class="nt">--prefix</span> <span class="nt">--keys-only</span> |grep <span class="nt">-Ev</span> <span class="s2">"^$"</span> |wc <span class="nt">-l</span>
240
</code></pre></div></div>

<h4 id="etcdä¸­keyå€¼çš„è§„å¾‹">ETCDä¸­keyå€¼çš„è§„å¾‹</h4>
<p>é€šè¿‡è§‚å¯Ÿå¯ä»¥ç®€å•å¾—å‡ºä¸‹é¢å‡ ä¸ªè§„å¾‹ï¼š</p>

<ul>
  <li>k8sä¸»è¦æŠŠè‡ªå·±çš„æ•°æ®æ³¨å†Œåœ¨<code class="language-plaintext highlighter-rouge">/registry/</code>å‰ç¼€ä¸‹é¢ï¼ˆåœ¨ETCD-v3ç‰ˆæœ¬åæ²¡æœ‰äº†ç›®å½•çš„æ¦‚å¿µï¼Œåªèƒ½ä¸€åˆ‡çš†å‰ç¼€äº†ï¼‰ã€‚</li>
  <li>é€šè¿‡è§‚å¯Ÿk8sä¸­<code class="language-plaintext highlighter-rouge">deploymentã€namespaceã€pod</code>ç­‰åœ¨ETCDä¸­çš„è¡¨ç¤ºï¼Œå¯ä»¥çŸ¥é“è¿™éƒ¨åˆ†èµ„æºçš„keyçš„æ ¼å¼ä¸º<code class="language-plaintext highlighter-rouge">/registry/#{k8så¯¹è±¡}/#{å‘½åç©ºé—´}/#{å…·ä½“å®ä¾‹å}</code>ã€‚</li>
  <li>å­˜åœ¨ä¸€ä¸ªä¸ä¼—ä¸åŒçš„keyå€¼<code class="language-plaintext highlighter-rouge">compact_rev_key</code>ï¼Œæœç´¢å¯ä»¥çŸ¥é“è¿™æ˜¯<a href="https://github.com/kubernetes/apiserver/blob/2710b17b80fbf42c29cd3e1193433b948b10cee3/pkg/storage/etcd3/compact.go">apiserver/compact.go</a>ä¸­ç”¨æ¥è®°å½•æ— æ•ˆæ•°æ®ç‰ˆæœ¬ä½¿ç”¨çš„ï¼›è¿è¡Œ<code class="language-plaintext highlighter-rouge">etcdctl get compact_rev_key</code>å¯ä»¥å‘ç°ï¼Œè¾“å‡ºçš„æ˜¯ä¸€ä¸ªæ•´å½¢æ•°å€¼ã€‚</li>
  <li>åœ¨æŸ¥çœ‹ETCDæ—¶ï¼Œk8sä¸­é™¤äº†å¿…è¦çš„ç½‘ç»œæ’ä»¶<a href="https://github.com/projectcalico/canal">canal</a>ï¼Œæœªéƒ¨ç½²å…¶ä»–çš„åº”ç”¨ï¼Œæ­¤æ—¶ETCDä¸­åªæœ‰240æ¡æ•°æ®ï¼Œä¸ªäººè§‰å¾—è¿™ä¸ªé‡çº§æ²¡æœ‰æƒ³è±¡ä¸­çš„å¤šã€‚</li>
</ul>

<p>æœ‰äº†ä¸Šé¢çš„è§„å¾‹ï¼Œå¯ä»¥åˆæ­¥å¾—å‡ºä¸€ä¸ªç»“è®ºï¼šåœ¨ç ”ç©¶k8sæ—¶é‡ç‚¹å…³æ³¨<code class="language-plaintext highlighter-rouge">/registry/</code>å‰ç¼€çš„keyåŠå…¶valueå³å¯ã€‚</p>

<h4 id="etcdä¸­çš„valueå€¼">ETCDä¸­çš„valueå€¼</h4>
<p>é€šè¿‡ä¸Šé¢çš„å†…å®¹çŸ¥é“ï¼Œk8såœ¨ETCDä¸­ä¿å­˜æ•°æ®æ—¶keyçš„å–å€¼éå¸¸è®²ç©¶ï¼Œè§„å¾‹éå¸¸å®¹æ˜“æ¦‚æ‹¬å‡ºæ¥ã€‚é‚£ä¹ˆè¿™äº›keyå€¼æ‰€å¯¹åº”çš„å€¼æ˜¯ä»€ä¹ˆæ ·å­å‘¢ï¼Ÿæˆ‘è¯•ç€è¾“å‡ºäº†<code class="language-plaintext highlighter-rouge">/registry/ranges/serviceips</code>å’Œ<code class="language-plaintext highlighter-rouge">/registry/services/endpoints/default/kubernetes</code>è¿™ä¸¤ä¸ªkeyæ‰€å¯¹åº”çš„å€¼ï¼Œæ•ˆæœè§ä¸‹é¢ç¼–ç å±•ç¤ºåŒºã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># è·å–"/registry/ranges/serviceips"æ‰€å¯¹åº”çš„å€¼</span>
<span class="c"># å‘ç°è¿™é‡Œæœ‰å¾ˆå¤šå¥‡æ€ªçš„å­—ç¬¦=ã€‚=</span>
<span class="c"># å¯ä»¥å¤§ä½“æ¨æ–­å‡ºæ¥ï¼Œé›†ç¾¤æ‰€æœ‰serviceçš„ipèŒƒå›´ä¸º10.96.0.0/12ï¼Œ ä¸api-serverçš„yamlæ–‡ä»¶ä¸­é…ç½®çš„ä¸€è‡´</span>
/<span class="nv">$ </span>etcdctl get /registry/ranges/serviceips
/registry/ranges/serviceips
k8s

v1RangeAllocation&amp;

<span class="s2">"*28Bz
      10.96.0.0/12"</span>

<span class="c"># è·å–"/registry/services/endpoints/default/kubernetes"æ‰€å¯¹åº”çš„å€¼</span>
<span class="c"># å‘ç°è¿™é‡Œæœ‰å¾ˆå¤šå¥‡æ€ªçš„å­—ç¬¦=ã€‚=</span>
<span class="c"># åœ¨defaultå‘½åç©ºé—´çš„kubernetesè¿™ä¸ªserviceæ‰€å¯¹åº”çš„endpointæœ‰ä¸¤ä¸ªip</span>
<span class="c"># åˆ†åˆ«ä¸º192.168.205.137å’Œ192.168.205.139</span>
/<span class="nv">$ </span>etcdctl get /registry/services/endpoints/default/kubernetes
/registry/services/endpoints/default/kubernetes
k8s

v1	Endpointsï¿½
O

kubernetesdefault<span class="s2">"*</span><span class="nv">$0b6bb724</span><span class="s2">-f066-11e8-be14-000c29d2cb3a2Úºï¿½ï¿½z;

192.168.205.137

192.168.205.139
httpsï¿½2TCP"</span>
</code></pre></div></div>

<p>å¯ä»¥å¾ˆæ˜æ˜¾çœ‹å‡ºæ¥ï¼ŒETCDä¸­ä¿å­˜çš„å¹¶ä¸æ˜¯è¾“å‡ºå‹å¥½çš„æ•°æ®ï¼ˆæ¯”å¦‚jsonæˆ–xmlç­‰å°±æ˜¯è¾“å‡ºå‹å¥½å‹æ•°æ®ï¼‰ã€‚å½“ç„¶ï¼Œå¦‚æœè¿›ä¸€æ­¥ç ”ç©¶å¯ä»¥çŸ¥é“ï¼ŒETCDä¿å­˜çš„æ˜¯<a href="https://developers.google.com/protocol-buffers/">Protocol Buffers</a>åºåˆ—åŒ–åçš„å€¼ã€‚å¦‚æœå¤§å®¶å¯¹Protobufæœ‰ç ”ç©¶ï¼Œå¯ä»¥çŸ¥é“è¿™ä¸ªåè®®ä¹Ÿæ˜¯ä¸ªkey-valueçš„åè®®ï¼Œåªä¸è¿‡ä¼šæŠŠå…¶key-valueå€¼æŒ‰ç…§ç‰¹å®šçš„ç®—æ³•è¿›è¡Œå‹ç¼©ï¼Œä¸è¿‡å¹¶æ²¡æœ‰å‹ç¼©çš„å¾ˆå‰å®³ï¼Œæ˜¾å¼è¾“å‡ºè¿™äº›å€¼å¤šå°‘ä¹Ÿèƒ½è·å–åˆ°ä¸€äº›ä¿¡æ¯ï¼›æ¯”å¦‚<code class="language-plaintext highlighter-rouge">/registry/services/endpoints/default/kubernetes</code>å¯¹åº”çš„<code class="language-plaintext highlighter-rouge">192.168.205.137ã€192.168.205.139</code>ç­‰å€¼ã€‚</p>

<h3 id="etcdä¸­å…¶ä»–çš„keyåŠå…¶value">ETCDä¸­å…¶ä»–çš„keyåŠå…¶value</h3>
<p>é€šè¿‡ä¸Šé¢çš„æ¢ç´¢ï¼Œå¯¹ETCDä¸­å­˜å‚¨çš„æ•°æ®æœ‰äº†å¤§ä½“çš„äº†è§£ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥å¼€å§‹æ›´åŠ åˆºæ¿€çš„å†’é™©äº†ã€‚</p>

<h4 id="æ®è¯´flanneléœ€è¦ä½¿ç”¨etcdä¿å­˜ç½‘ç»œå…ƒæ•°æ®">æ®è¯´flanneléœ€è¦ä½¿ç”¨ETCDä¿å­˜ç½‘ç»œå…ƒæ•°æ®</h4>
<p>é‚£ä¹ˆï¼Œflannelåœ¨ETCDä¸­ä¿å­˜çš„æ•°æ®æ˜¯ä»€ä¹ˆï¼Œä¿å­˜åœ¨å“ªä¸ªkeyä¸­äº†å‘¢ï¼Ÿä¸‹é¢æŠŠæ‰€æœ‰ç½‘å…³ç›¸å…³çš„å‡ ä¸ªå…³é”®è¯ <code class="language-plaintext highlighter-rouge">canal|flannel|calico</code>è¾“å‡ºå¯ä»¥çŸ¥é“ï¼Œé‡Œé¢åªæœ‰ä¸€ä¸ªå¯èƒ½åŒ…å«flannelæ‰€éœ€æ•°æ®çš„keyï¼Œå³<code class="language-plaintext highlighter-rouge">/registry/configmaps/kube-system/canal-config</code>ï¼Œè¾“å‡ºå†…å®¹åå¯¹æ¯”<a href="https://coreos.com/flannel/docs/latest/flannel-config.html">å…³äºflannelçš„etcdé…ç½®</a>è¿™ç¯‡æ–‡ç« ï¼Œå¾ˆå¤§ç¨‹åº¦å¯ä»¥è®¤ä¸ºå°±æ˜¯å®ƒäº†ï¼ˆéœ€è¦è¿›ä¸€æ­¥å»canalé¡¹ç›®çš„æºç ä¸­å»ç¡®è®¤ï¼‰ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/<span class="nv">$ </span>etcdctl get <span class="s2">""</span> <span class="nt">--prefix</span> <span class="nt">--keys-only</span> |grep <span class="nt">-Ev</span> <span class="s2">"^$"</span> |grep <span class="s2">"canal</span><span class="se">\|</span><span class="s2">flannel</span><span class="se">\|</span><span class="s2">calico"</span>
<span class="c"># ... å¿½ç•¥å¾ˆå¤šæ¡</span>
/registry/configmaps/kube-system/canal-config
<span class="c"># ... å¿½ç•¥å¾ˆå¤šæ¡</span>

<span class="c"># å¯ä»¥çœ‹åˆ°é‡Œé¢æœ‰ä¸€ä¸ªé…ç½®é¡¹ net-confï¼Œ å¯¹æ¯”flannelçš„é…ç½®ï¼Œå¯ä»¥è®¤ä¸ºè¿™ä¸ªåœ°æ–¹å¾ˆå¯èƒ½å°±æ˜¯canalé¡¹ç›®ä¸­flannelåœ¨etcdä¸­éœ€è¦çš„å€¼ã€‚è¿™é‡Œè®¾ç½®äº†ç½‘æ®µä¸º"10.244.0.0/16"</span>
/<span class="nv">$ </span>etcdctl get /registry/configmaps/kube-system/canal-config
<span class="c"># ... çœç•¥å¾ˆå¤š</span>
net-conf.jsonI<span class="o">{</span>
  <span class="s2">"Network"</span>: <span class="s2">"10.244.0.0/16"</span>,
  <span class="s2">"Backend"</span>: <span class="o">{</span>
    <span class="s2">"Type"</span>: <span class="s2">"vxlan"</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="defaultå‘½åç©ºé—´ä¸­endpointå®ä¾‹kubernetesçš„å€¼">defaultå‘½åç©ºé—´ä¸­endpointå®ä¾‹kubernetesçš„å€¼</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># åœ¨k8sçš„HAéƒ¨ç½²æ—¶ï¼Œä¼šå‘ç°defaultå‘½åç©ºé—´æœ‰ä¸€ä¸ªé»˜è®¤çš„service</span>
<span class="c"># æ˜æ˜æ²¡æœ‰selectorï¼ˆå¦‚æœä¸ç†Ÿæ‚‰è¿™ä¸ªæ¦‚å¿µå¯ä»¥è‡ªè¡Œå»æœç´¢äº†è§£ä¸€ä¸‹ï¼‰ï¼Œå´æœ‰å®å®åœ¨åœ¨çš„Endpointså€¼</span>
<span class="c"># é‚£ä¹ˆè¿™ä¸ªå€¼æ˜¯å¦‚ä½•å†™å…¥çš„å‘¢ï¼Ÿ</span>
/<span class="nv">$ </span>kubectl describe svc kubernetes
Name:              kubernetes
Namespace:         default
Labels:            <span class="nv">component</span><span class="o">=</span>apiserver
                   <span class="nv">provider</span><span class="o">=</span>kubernetes
Annotations:       &lt;none&gt;
Selector:          &lt;none&gt;
Type:              ClusterIP
IP:                10.96.0.1
Port:              https  443/TCP
TargetPort:        6443/TCP
Endpoints:         192.168.205.137:6443,192.168.205.139:6443
Session Affinity:  ClientIP
Events:            &lt;none&gt;

<span class="c"># é€šè¿‡åœ¨ETCDä¸­æ£€ç´¢å¯ä»¥è·å–åˆ°ä¸¤ä¸ªkeyå€¼</span>
<span class="c"># ä¸€ä¸ªå¯¹åº”çš„æ˜¯defaultå‘½åç©ºé—´ä¸­çš„serviceï¼Œå¦ä¸€ä¸ªæ˜¯å¯¹åº”çš„endpoint</span>
/<span class="nv">$ </span>etcdctl get <span class="s2">""</span> <span class="nt">--prefix</span> <span class="nt">--keys-only</span> |grep <span class="nt">-Ev</span> <span class="s2">"^$"</span> |grep <span class="s2">"default"</span> |grep <span class="s2">"kubernetes"</span>
/registry/services/endpoints/default/kubernetes
/registry/services/specs/default/kubernetes
</code></pre></div></div>

<p>æˆ‘æŠŠ<code class="language-plaintext highlighter-rouge">/registry/services/endpoints/default/kubernetes</code>è¾“å…¥åˆ°æœç´¢å¼•æ“æœç´¢äº†ä¸€ä¸‹ï¼Œå‘ç°<a href="https://github.com/kubernetes/kubernetes/issues/19989">æœ‰äºº</a>åœ¨githubä¸ŠæŠ›å‡ºç±»ä¼¼çš„é—®é¢˜ï¼Œä»å…¶<code class="language-plaintext highlighter-rouge">The three apiservers (Ip Adresses .31,.32,.33) are constantly overwriting the etcd-key /registry/services/endpoints/default/kubernetes</code>å¯ä»¥æ¨æµ‹å‡ºæ¥ï¼Œè¿™ä¸ªå€¼æ˜¯api-serverè¿™ä¸ªæ§ä»¶ä¸»åŠ¨å»å†™å…¥çš„ã€‚</p>

<p>è¿™èƒ½å¾—å‡ºä¸€ä¸ªç»“è®ºï¼šåœ¨éƒ¨ç½²é«˜å¯ç”¨é›†ç¾¤æ—¶ï¼Œå¦‚æœæƒ³æŠŠå¤šä¸ªapi-serveræ³¨å†Œåˆ°é›†ç¾¤ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„api-serverçš„æœåŠ¡éƒ½å°†ä¼šå‡ºç°åœ¨defaultå‘½åç©ºé—´çš„kubernetesè¿™ä¸ªendpointsä¸Šï¼›è¿™ä¹Ÿå°±æ„å‘³ç€éš¾ä»¥æŠŠé›†ç¾¤ä¸­çš„ä¸€ä¸ªapi-serverå•ç‹¬éš”ç¦»å‡ºæ¥è€Œä¸è®©å®ƒå¯¹å¤–æä¾›æœåŠ¡ï¼ˆæˆ‘å½“å‰æƒ³debugçš„ä¸€ä¸ªé—®é¢˜éœ€è¦è¿™ä¹ˆæ“ä½œï¼Œå¾—å‡ºè¿™ä¸ªç»“è®ºè¡¨ç¤ºå¾ˆæ— å¥ˆï¼‰ã€‚</p>

<h2 id="å°ç»“">å°ç»“</h2>
<p>æ–‡æœ¬å¯¹k8sæ•°æ®ä»“åº“ETCDè¿›è¡Œäº†æ¢ç©¶ï¼Œæ€»ç»“äº†ETCDä¿å­˜k8sæ•°æ®æ—¶keyå€¼çš„è§„èŒƒï¼Œå¹¶å°è¯•æŸ¥çœ‹äº†valueå€¼çš„å†…å®¹ã€‚æœ€åå¯¹å‡ ä¸ªæ„Ÿå…´è¶£çš„keyå€¼åŠå…¶valueå€¼è¿›è¡Œäº†æ¢ç´¢ã€‚é€šè¿‡æ¢ç©¶å¯ä»¥çŸ¥é“ï¼Œk8sæŠŠé›†ç¾¤çš„ä¿¡æ¯éå¸¸æœ‰æ¡ç†åœ°ä¿å­˜åœ¨ETCDä¸­ï¼Œkeyå€¼å®šä¹‰æœ‰ç« å¯å¾ªï¼Œæ¯”è¾ƒæ–¹ä¾¿debugï¼›åŒæ—¶ï¼Œè™½ç„¶ETCDä¸­çš„valueå€¼æ˜¯protobufåºåˆ—åŒ–åçš„æ•°æ®ï¼Œä¸é€‚åˆå±•ç¤ºï¼Œä¸è¿‡è¾“å‡ºåˆ°æ–‡æœ¬åä¾ç„¶æœ‰ä¸€å®šçš„å‚è€ƒä»·å€¼ã€‚</p>

<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
  <li><a href="https://kubernetes.io/">Production-Grade Container Orchestration - Kubernetes</a>  Kuberneteså®˜ç½‘</li>
  <li><a href="http://docs.kubernetes.org.cn/227.html">Kubernetesæ˜¯ä»€ä¹ˆ _ Kubernetes(K8S)ä¸­æ–‡æ–‡æ¡£_Kubernetesä¸­æ–‡ç¤¾åŒº</a> k8sä¸­æ–‡æ–‡æ¡£</li>
  <li><a href="https://github.com/cookeem/kubeadm-ha/">GitHub - cookeem/kubeadm-ha: Kubernetes high availiability deploy based on kubeadm (English/ä¸­æ–‡ for v1.11.x/v1.9.x/v1.7.x/v1.6.x)</a> k8sé«˜å¯ç”¨éƒ¨ç½²æ–¹æ¡ˆ</li>
  <li><a href="https://docs.projectcalico.org/v3.3/getting-started/kubernetes/installation/flannel">Installing Calico for policy and flannel for networking</a> ç½‘ç»œæ’ä»¶çš„å®‰è£…</li>
  <li><a href="https://coreos.com/flannel/docs/latest/flannel-config.html">flannel Container Networking | Configuring flannel Networking</a>  æè¿°äº†flannelé…ç½®etcdä½œä¸ºdatastoreçš„åšæ³•ï¼Œå¯ä»¥æ¨æ•²å‡ºetcdä¸­ä¿å­˜çš„å€¼å¯èƒ½çš„æ ·å­</li>
  <li><a href="https://github.com/coreos/flannel/blob/master/Documentation/configuration.md">flannel/configuration.md at master Â· coreos/flannel Â· GitHub</a> flannelé…ç½®etcdä½œä¸ºdatastoreçš„æ–‡æ¡£</li>
  <li><a href="https://github.com/kubernetes/kubernetes/issues/19989">Kubernetes service multiple apiserver endpoints Â· Issue #19989 Â· kubernetes/kubernetes Â· GitHub</a> ä»è¿™é‡Œçš„æè¿°å¯ä»¥çœ‹å‡ºapi-serveræœ¬èº«ä¸»åŠ¨å‘ETCDå†™æ•°æ®</li>
</ul>

    </article>

    
    <div class="social-share-wrapper">
      <div class="social-share"></div>
    </div>
    
  </div>

  <section class="author-detail">
    <section class="post-footer-item author-card">
      <div class="avatar">
        <img src="https://jingwei.link/assets/img/profile.png" alt="">
      </div>
      <div class="author-name" rel="author">Jingç»´</div>
      <div class="bio">
        <p>Stay hungry, stay foolish</p>
      </div>
      
      <ul class="sns-links">
        
        <li>
          <a href="mailto:zhjw43@163.com" target="_blank">
                    <i class="iconfont icon-email"></i>
                </a>
        </li>
        
        <li>
          <a href="https://github.com/chalvern" target="_blank">
                    <i class="iconfont icon-github"></i>
                </a>
        </li>
        
      </ul>
      
    </section>
    <section class="post-footer-item read-next">
      
      <div class="read-next-item">
        <a href="/2018/11/28/kubeadm-init-research.html" class="read-next-link"></a>
        <section>
          <span>Kubernetesæ­å»ºä¹‹kubeadm-initæ¢ç©¶</span>
          <p></p>
        </section>
        
        <div class="filter"></div>
        <img src="" alt="">
        
     </div>
      

      
      <div class="read-next-item">
        <a href="/2018/11/18/gorm-err-record-not-found.html" class="read-next-link"></a>
          <section>
            <span>GORMæœ€ä½³å®è·µä¹‹ErrRecordNotFoundçš„å‘</span>
            <p></p>
          </section>
          
          <div class="filter"></div>
          <img src="" alt="">
          
      </div>
      
    </section>
    <section class="post-footer-item comment">
      <div id="disqus_thread"></div>
    </section>
  </section>

  <footer class="g-footer">
  <section>æ•¬ç»´ Â©
  
  
    2018
    -
  
  2024
  <a href="/rss.xml">RSSè®¢é˜…</a>
  </section>
</footer>


  <script src="/assets/js/social-share.min.js"></script>
  <script>
    socialShare('.social-share', {
      sites: [
        
          'wechat'
          ,
          
        
          'weibo'
          ,
          
        
          'douban'
          ,
          
        
          'twitter'
          
        
      ],
      wechatQrcodeTitle: "åˆ†äº«åˆ°å¾®ä¿¡æœ‹å‹åœˆ",
      wechatQrcodeHelper: '<p>æ‰«ç åç‚¹å‡»å³ä¸Šè§’</p><p>å°†æœ¬æ–‡åˆ†äº«è‡³æœ‹å‹åœˆ</p>'
    });
  </script>

  

  <script src="/assets/js/prism.js"></script>
  <script src="/assets/js/index.min.js"></script>
</body>

</html>
